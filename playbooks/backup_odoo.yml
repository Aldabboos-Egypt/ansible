---
- name: Backup Odoo databases 
  hosts: all
  vars:
    backup_dir: /root/odoo_backups

  tasks:
    - name: Create backup directory
      file:
        path: "{{ backup_dir }}"
        state: directory

    - name: Create Odoo database backup using curl
      command: >
        curl -X POST
        -F "master_pwd={{ admin_password }}"
        -F "name={{ odoo_database }}"
        -F "backup_format=zip"
        -o "{{ backup_dir }}/{{ odoo_database }}_{{ lookup('pipe', 'date +%F_%H-%M-%S') }}.zip"
        https://{{ odoo_domain }}/web/database/backup
      register: curl_result
      failed_when: curl_result.rc != 0 or "End-of-central-directory signature not found" in curl_result.stderr
    
 


    - name: Delete old backups
      find:
        paths: "{{ backup_dir }}"
        patterns: "{{ odoo_database }}_*.zip"
        age: 7d
        recurse: yes
      register: old_backups

    - name: Remove old backups
      file:
        path: "{{ item.path }}"
        state: absent
      loop: "{{ old_backups.files }}"
      when: old_backups.matched > 0
