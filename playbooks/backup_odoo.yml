---
- name: Backup Odoo databases on multiple servers
  hosts: all
  vars:
    backup_dir: /root/odoo_backups

  tasks:
    - name: Create backup directory
      file:
        path: "{{ backup_dir }}"
        state: directory

    - name: Create Odoo database backup
      uri:
        url: "https://{{ odoo_database }}/web/database/backup"
        method: POST
        return_content: yes
        body_format: form-urlencoded
        body:
          master_pwd: "{{ admin_password }}"
          name: "{{ odoo_database }}"
          backup_format: zip
      register: backup_response

    - name: Save the backup response to a temporary file
      copy:
        content: "{{ backup_response.content }}"
        dest: "/tmp/{{ odoo_database }}.tmp"

    - name: Download the actual backup file
      get_url:
        url: "https://{{ odoo_database }}/web/database/backup"
        dest: "{{ backup_dir }}/{{ odoo_database }}_{{ lookup('pipe', 'date +%F_%H-%M-%S') }}.zip"
        method: POST
        headers:
          Content-Type: application/x-www-form-urlencoded
        body: "master_pwd={{ admin_password }}&name={{ odoo_database }}&backup_format=zip"
        force: yes

    - name: Delete old backups
      find:
        paths: "{{ backup_dir }}"
        patterns: "{{ odoo_database }}_*.zip"
        age: 7d
        recurse: yes
      register: old_backups

    - name: Remove old backups
      file:
        path: "{{ item.path }}"
        state: absent
      loop: "{{ old_backups.files }}"
      when: old_backups.matched > 0
